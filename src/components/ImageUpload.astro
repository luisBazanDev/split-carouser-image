<form
  class="flex flex-col items-center justify-center bg-gray-100 p-6 rounded-lg shadow-md"
  id="image-upload"
  method="post"
>
  <div class="flex gap-2 items-center mb-4">
    <span>Split mode</span>
    <select
      name="type"
      id="form-type"
      class="p-2 rounded border border-gray-300"
    >
      <option value="horizontal">Horizontal</option>
      <option value="vertical">Vertical</option>
    </select>
  </div>
  <div class="flex gap-2 items-center mb-4">
    <span>Number of images out</span>
    <input
      type="number"
      name="amount"
      id="form-amount"
      min="2"
      max="20"
      placeholder="Amount of images"
      value="2"
      class="p-2 rounded border border-gray-300"
    />
  </div>
  <div class="flex gap-2 items-center mb-4">
    <span>Select file</span>
    <input
      type="file"
      accept="jpg,png"
      id="form-image"
      placeholder="Image to split"
      class="p-2 rounded border border-gray-300"
    />
  </div>
  <button
    type="submit"
    class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex gap-2 items-center hover:scale-105 transition-all active:scale-90 cursor-pointer"
  >
    <div class="w-3 h-3 bg-white rounded-xs spin hidden" id="spin"></div>
    Submit</button
  >
</form>

<style>
  .spin {
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    0% {
      rotate: 0;
      scale: 0.5;
    }
    50% {
      scale: 1;
    }
    100% {
      rotate: 360deg;
      scale: 0.5;
    }
  }
</style>

<script>
  import { actions } from "astro:actions";

  const form = document.getElementById("image-upload");

  form?.addEventListener("submit", async (event) => {
    document.getElementById("spin")?.classList.remove("hidden");
    event.preventDefault();
    const type = (document.getElementById("form-type") as HTMLSelectElement)
      .value;
    const amount = parseInt(
      (document.getElementById("form-amount") as HTMLInputElement).value,
    );
    const imageInput = (
      document.getElementById("form-image") as HTMLInputElement
    ).files?.[0];

    if (imageInput) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const imageBase64 = reader.result as string;

        const img = new Image();
        img.src = imageBase64;
        img.onload = async () => {
          const width = img.width;
          const height = img.height;

          actions
            .splitImage({
              type,
              amount,
              image: imageBase64,
              width,
              height,
            })
            .then(async (response: any) => {
              if (response && response.data) {
                const downloadLink = document.createElement("a");
                downloadLink.href = `data:application/zip;base64,${response.data}`; // Assuming response.data is base64 for the zip file
                downloadLink.download = "images.zip"; // Changed to a zip file download
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
              } else {
                console.error("Error: Invalid response from server.");
              }
              document.getElementById("spin")?.classList.add("hidden");
            });
        };
      };
      reader.readAsDataURL(imageInput);
    } else {
      console.error("No image file selected.");
    }
  });
</script>
